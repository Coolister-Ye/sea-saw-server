from ..base import BaseSerializer
from ..shared import AttachmentSerializer
from .outbound_item import (
    OutboundItemSerializer,
    OutboundItemSerializerForAdmin,
    OutboundItemSerializerForSales,
    OutboundItemSerializerForProduction,
    OutboundItemSerializerForWarehouse,
)

from ...models.outbound import OutboundOrder
from ...models import Attachment
from ...mixins import ReusableAttachmentWriteMixin
from django.utils.translation import gettext_lazy as _
from drf_writable_nested.mixins import UniqueFieldsMixin


class OutboundOrderSerializer(
    ReusableAttachmentWriteMixin, UniqueFieldsMixin, BaseSerializer
):
    """Outbound Order serializer (default: admin view)."""

    outbound_items = OutboundItemSerializer(
        many=True, required=False, allow_null=True, label=_("Outbound Items")
    )
    attachments = AttachmentSerializer(
        many=True, required=False, label=_("Attachments")
    )

    attachment_model = Attachment

    class Meta(BaseSerializer.Meta):
        model = OutboundOrder
        fields = [
            "id",
            "outbound_code",
            "pipeline",
            "outbound_date",
            "status",
            "container_no",
            "seal_no",
            "destination_port",
            "logistics_provider",
            "loader",
            "remark",
            "outbound_items",
            "attachments",
            "owner",
            "created_at",
            "updated_at",
            "created_by",
            "updated_by",
        ]


class OutboundOrderSerializerForAdmin(OutboundOrderSerializer):
    """Admin can edit all outbound items."""

    outbound_items = OutboundItemSerializerForAdmin(
        many=True, required=False, allow_null=True, label=_("Outbound Items")
    )
    attachments = AttachmentSerializer(
        many=True, required=False, label=_("Attachments")
    )

    class Meta(OutboundOrderSerializer.Meta):
        fields = OutboundOrderSerializer.Meta.fields


class OutboundOrderSerializerForSales(OutboundOrderSerializer):
    """Sales read-only."""

    outbound_items = OutboundItemSerializerForSales(
        many=True, required=False, allow_null=True, label=_("Outbound Items")
    )

    class Meta(OutboundOrderSerializer.Meta):
        fields = OutboundOrderSerializer.Meta.fields
        read_only_fields = OutboundOrderSerializer.Meta.fields


class OutboundOrderSerializerForProduction(OutboundOrderSerializer):
    """Production read-only."""

    outbound_items = OutboundItemSerializerForProduction(
        many=True, required=False, allow_null=True, label=_("Outbound Items")
    )

    class Meta(OutboundOrderSerializer.Meta):
        fields = OutboundOrderSerializer.Meta.fields
        read_only_fields = OutboundOrderSerializer.Meta.fields


class OutboundOrderSerializerForWarehouse(OutboundOrderSerializer):
    """Warehouse limited write."""

    outbound_items = OutboundItemSerializerForWarehouse(
        many=True, required=False, allow_null=True, label=_("Outbound Items")
    )

    class Meta(OutboundOrderSerializer.Meta):
        fields = OutboundOrderSerializer.Meta.fields
